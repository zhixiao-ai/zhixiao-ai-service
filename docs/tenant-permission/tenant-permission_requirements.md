# 多租户权限管理功能需求

**文档版本**: 1.0.4
**创建日期**: 2026-01-27
**最后更新**: 2026-01-28
**维护团队**: 知晓AI平台团队

## 1. 需求背景和概述

### 1.1 需求背景

知晓AI平台作为企业级AI RAG服务平台,需要为多个企业或组织(租户)提供服务。每个租户拥有独立的资源、用户体系和权限管控机制。平台需要实现:

- **多租户资源隔离**: 确保不同租户之间的数据完全隔离,互不干扰
- **跨租户用户管理**: 一个用户可以加入多个租户,在不同租户中拥有不同的权限
- **细粒度权限控制**: 租户管理员可以为用户配置各类资源(模型、知识库等)的访问权限
- **权限分级管理**: 支持租户管理员、普通用户等不同角色

### 1.2 需求概述

本需求旨在构建一套完整的多租户权限管理体系,包括:

1. **租户管理**: 租户的创建、配置、启用/停用
2. **租户成员管理**: 用户加入/退出租户,用户在租户中的角色管理
3. **角色权限体系**: 预定义角色(租户管理员、普通用户等)和自定义角色
4. **资源权限控制**: 针对模型、知识库、数据集等资源的细粒度权限控制
5. **数据隔离机制**: 确保租户间数据严格隔离

## 2. 影响用户、角色、重要程度

### 2.1 影响用户

| 用户类型 | 描述 | 受影响功能 |
|---------|------|-----------|
| **平台超级管理员** | 平台级别的管理员,负责租户的创建、分配配额等 | 租户管理、全局配置 |
| **租户管理员** | 租户的最高权限管理者,负责租户内成员、权限、资源配置 | 成员管理、角色管理、权限分配 |
| **租户普通用户** | 租户内的普通用户,根据被授予的权限访问资源 | 资源访问、权限查看 |

### 2.2 重要程度

**重要等级**: ⭐⭐⭐⭐⭐ (核心功能)

**理由**:
- 多租户权限管理是平台的基础能力,直接影响数据安全和用户体验
- 资源隔离是平台商业化的前提,是不同企业客户独立使用的关键保障
- 权限控制是系统安全的核心,防止数据泄露和越权访问

## 3. 功能性描述

### 3.1 租户管理

#### 3.1.1 租户创建与配置

**功能描述**: 平台超级管理员可以创建新的租户,并配置租户基本信息。

**核心功能点**:
- **租户基本信息**
  - 租户名称(必填,全局唯一)
  - 租户代码(必填,全局唯一,用于系统标识)
  - 租户描述
  - 租户Logo
  - 联系信息(邮箱、电话)

- ~~**租户配额配置**~~ ❌ 暂不考虑
  - ~~用户数量上限~~
  - ~~模型数量上限~~
  - ~~知识库数量上限~~
  - ~~存储空间上限(GB)~~
  - ~~API调用次数上限(月度)~~
  - **决策**: 当前版本不实现租户配额管理,租户资源数量不受限制

- **租户状态管理**
  - 启用状态:正常使用
  - 停用状态:暂停使用,保留数据
  - 过期状态:超过有效期,锁定所有操作

- **租户有效期管理**
  - 开始时间
  - 结束时间
  - 到期提醒(提前7天、3天、1天)

#### 3.1.2 租户信息维护

**功能描述**: 租户管理员可以维护租户的公有信息,供租户内所有成员查看。

**核心功能点**:
- **租户公告管理**
  - 发布公告(标题、内容、优先级)
  - 编辑/删除公告
  - 公告有效期

- **租户配置管理**
  - 默认语言
  - 默认时区
  - 密码策略(复杂度要求、有效期)
  - 会话超时时间

- **租户品牌定制**
  - 自定义Logo
  - 自定义主题色
  - 自定义登录页背景

### 3.2 租户成员管理

#### 3.2.1 用户加入租户

**功能描述**: 支持多种方式让用户加入租户。

**核心功能点**:
- **邀请加入**
  - 租户管理员通过邮箱邀请用户加入
  - 邀请链接有效期(默认7天,可配置)
  - 邀请时可以指定用户角色,**如不指定则默认为普通用户(USER)**
  - 邀请时可以指定额外权限,**如不指定则使用该角色的默认权限**
  - 邀请状态:待接受、已接受、已过期、已撤销

- **申请加入**
  - 用户通过租户代码申请加入租户
  - 租户管理员审核(批准/拒绝)
  - 审核通过时,管理员可以指定用户角色,**如不指定则默认为普通用户(USER)**
  - 审核通知(邮件、站内信)

- **直接添加**
  - 租户管理员直接添加已注册用户
  - 添加时可以指定用户角色,**如不指定则默认为普通用户(USER)**
  - 添加时可以指定额外权限,**如不指定则使用该角色的默认权限**
  - 用户收到加入通知

- **加入限制**
  - ~~检查租户用户数量上限~~ (当前版本不限制)
  - 同一用户在同一租户只能有一个成员身份
  - 用户可以同时加入多个租户

- **新用户默认角色和权限**
  - **默认角色**: 新加入租户的用户,如未指定角色,则默认为普通用户(USER)
  - **角色默认权限**: 每个角色可以配置默认权限模板,用户获得该角色时自动应用默认权限
  - **权限继承**: 用户的最终权限 = 角色默认权限 + 管理员额外分配的权限
  - **默认权限可配置**: 租户管理员可以为每个角色配置默认权限模板

#### 3.2.2 租户成员管理

**功能描述**: 租户管理员管理租户内的成员。

**核心功能点**:
- **成员列表**
  - 查看所有成员
  - 支持按角色、状态、加入时间筛选
  - 成员信息:用户名、邮箱、角色、加入时间、最后活跃时间

- **成员角色管理**
  - 修改成员角色
  - 角色变更通知
  - 角色变更记录审计

- **成员状态管理**
  - 启用/停用成员(停用后无法登录租户)
  - 移除成员(退出租户)
  - 成员主动退出租户

- **成员信息查看**
  - 查看成员基本信息
  - 查看成员当前权限
  - 查看成员操作日志

### 3.3 角色与权限体系

#### 3.3.1 预定义角色

**功能描述**: 系统提供预定义角色,满足基本的权限管理需求。

**核心角色**:

| 角色名称 | 角色代码 | 描述 | 默认权限 |
|---------|---------|------|---------|
| **租户管理员** | `TENANT_ADMIN` | 租户最高权限者 | **自动拥有当前租户的所有权限,不需要额外分配**。包括成员管理、角色管理、权限分配、资源配置、可以创建其他租户管理员等所有管理功能 |
| **模型管理员** | `MODEL_ADMIN` | 模型资源管理者 | 模型的创建、编辑、删除、发布权限(可配置默认权限模板) |
| **知识库管理员** | `KNOWLEDGE_ADMIN` | 知识库资源管理者 | 知识库的创建、编辑、删除、发布权限(可配置默认权限模板) |
| **普通用户** | `USER` | 普通使用者 | 可配置默认权限模板,通常为最基本的资源访问权限 |

#### 3.3.2 自定义角色

**功能描述**: 租户管理员可以创建自定义角色,灵活分配权限。

**核心功能点**:
- **角色定义**
  - 角色名称(租户内唯一)
  - 角色描述
  - 角色类型(管理角色、普通角色)
  - 角色状态(启用/停用)

- **权限配置**
  - 选择资源类型(模型、知识库、数据集等)
  - 选择操作权限(查看、创建、编辑、删除、发布、共享等)
  - 批量授权

- **角色默认权限模板**
  - **为角色配置默认权限**,用户获得该角色时自动应用这些权限
  - 支持为预定义角色(模型管理员、知识库管理员、普通用户)配置默认权限
  - 支持为自定义角色配置默认权限
  - **租户管理员可自定义**不同角色的默认权限,适应不同租户的需求
  - 默认权限可以随时修改,**修改后影响所有拥有该角色的用户**(可选:仅影响新用户)
  - 可以预览某个角色的所有有效权限

- **角色管理**
  - 编辑角色权限
  - 停用/启用角色
  - 删除角色(检查是否有用户使用)

- **管理员角色分配**
  - **租户管理员可以将其他成员提升为租户管理员**
  - **租户管理员也可以移除其他租户管理员的管理员身份**
  - 租户至少保留一名管理员,移除最后一名管理员时系统提示
  - 管理员身份变更时记录审计日志

### 3.4 资源权限控制

#### 3.4.1 资源类型与权限矩阵

**功能描述**: 定义不同资源类型的权限粒度。

**资源权限矩阵**:

| 资源类型 | 查看权限 | 创建权限 | 编辑权限 | 删除权限 | 发布权限 | 共享权限 |
|---------|---------|---------|---------|---------|---------|---------|
| **AI模型** | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| **知识库** | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| **数据集** | ✓ | ✓ | ✓ | ✓ | - | ✓ |
| **对话会话** | ✓ | ✓ | ✓ | ✓ | - | - |
| **API密钥** | ✓ | ✓ | ✓ | ✓ | - | - |

#### 3.4.2 模型访问权限

**功能描述**: 细粒度控制用户对AI模型的访问权限。

**核心功能点**:
- **权限级别**
  - **完全控制**: 可以查看、编辑、删除、发布、共享模型
  - **编辑权限**: 可以查看、编辑、发布模型
  - **使用权限**: 只能使用模型进行对话,不能修改模型
  - **查看权限**: 只能查看模型的基本信息和配置

- **权限分配方式**
  - **按角色分配**: 给角色分配模型权限,该角色下的用户自动继承
  - **按用户分配**: 直接给用户分配模型权限
  - **按资源分配**: 给指定模型分配可访问的用户/角色列表

- **模型权限配置**
  - 选择模型(单选/多选)
  - 选择授权对象(用户/角色)
  - 选择权限级别
  - 设置有效期(可选)

#### 3.4.3 知识库访问权限

**功能描述**: 控制用户对知识库的访问和操作权限。

**核心功能点**:
- **权限级别**
  - **完全控制**: 查看、编辑、删除、发布、共享知识库
  - **编辑权限**: 查看、编辑、上传文档、发布知识库
  - **贡献权限**: 查看、上传文档、编辑自己上传的文档
  - **使用权限**: 只能使用知识库进行问答,不能修改内容
  - **查看权限**: 只能查看知识库的基本信息和文档列表

- **权限继承**
  - 知识库支持分组,子知识库可以继承父知识库的权限
  - 支持多级权限继承(知识库树形结构,可以有多层父子关系)
  - **权限冲突处理原则**: 当父级权限和子级权限冲突时,**以子级权限为准**(子级权限优先级高于父级)
  - 子知识库可以单独配置权限,既可以比父级更宽松,也可以更严格

- **文档级权限**(可选)
  - 可以为知识库中的特定文档设置访问权限
  - 文档权限可以比知识库权限更严格

#### 3.4.4 其他资源权限

**功能描述**: 对其他资源的权限控制。

**数据集权限**:
- 完全控制、编辑权限、使用权限、查看权限
- 数据集可以作为训练数据、测试数据使用

**API密钥权限**:
- 完全控制、使用权限
- API密钥可以绑定到特定用户或角色

**对话会话权限**:
- 用户只能查看和管理自己的对话会话
- 管理员可以查看所有会话

#### 3.4.5 权限分配界面

**功能描述**: 提供直观的权限分配界面。

**核心功能点**:
- **权限视图**
  - **按用户视图**: 查看用户拥有的所有权限
  - **按角色视图**: 查看角色拥有的所有权限
  - **按资源视图**: 查看哪些用户/角色可以访问某个资源

- **批量操作**
  - 批量给用户/角色分配权限
  - 批量移除权限
  - 权限模板(保存常用的权限组合)

- **权限搜索**
  - 按资源类型筛选
  - 按权限级别筛选
  - 按用户/角色筛选
  - 按有效期筛选(即将过期、已过期、永久有效)

#### 3.4.6 权限时效管理

**功能描述**: 支持临时授权功能,可以为用户分配有时效性的权限,权限到期后自动回收。

**核心功能点**:
- **临时授权配置**
  - 在分配权限时可选择有效期设置
  - 支持相对时间(如:7天、30天、90天)
  - 支持绝对时间(指定到期日期和时间)
  - 支持永久权限(不设置有效期)
  - 到期时间可延长或缩短

- **权限自动回收**
  - 系统定时任务检查权限到期状态
  - 到期权限自动失效(权限状态变为"已过期")
  - 权限失效后用户无法访问对应资源
  - 权限失效通知(到期前1天、到期当天通知用户和管理员)

- **权限续期管理**
  - 管理员可以手动续期权限
  - 批量续期(选择多个即将到期的权限统一延长)
  - 自动续期规则(可选,如VIP用户权限自动续期)

- **权限有效期查询**
  - 查看用户的所有权限及有效期
  - 按到期时间排序(优先显示即将到期的权限)
  - 筛选即将到期(7天内、30天内)的权限
  - 筛选已过期但仍保留记录的权限

- **权限到期策略**
  - **立即失效模式**: 权限到期后立即失效,用户无法访问
  - **宽限期模式** (可选): 权限到期后进入宽限期(如7天),宽限期内仍可访问,但显示提醒
  - **归档模式**: 过期权限保留历史记录,不立即删除,便于审计和重新授权

- **权限时效与角色权限的关系**
  - 通过角色获得的权限也可以设置时效(时效优先于角色)
  - 用户直接分配的权限时效优先于角色权限时效
  - 角色被移除时,该角色下的所有时效权限自动失效

### 3.5 数据隔离机制

#### 3.5.1 租户数据隔离

**功能描述**: 确保不同租户之间的数据完全隔离。

**核心机制**:
- **数据库隔离**
  - 所有业务表添加 `tenant_id` 字段
  - 所有查询自动添加租户过滤条件
  - 禁止跨租户的数据访问

- **缓存隔离**
  - Redis key 设计包含租户ID
  - 不同租户的缓存数据完全分离

- **文件隔离**
  - 文件存储路径包含租户ID
  - 文件访问权限校验

#### 3.5.2 用户租户上下文

**功能描述**: 用户在多个租户中切换时,正确加载租户上下文。

**核心功能点**:
- **当前租户选择**
  - 用户登录后显示可访问的租户列表
  - 用户选择当前工作的租户
  - 记住用户上次选择的租户

- **租户上下文切换**
  - 切换租户时清空当前租户的数据
  - 重新加载新租户的权限和资源
  - 记录租户切换日志

### 3.6 权限校验机制

#### 3.6.1 接口级权限校验

**功能描述**: 在API接口层进行权限校验,防止越权访问。

**核心机制**:
- **注解式权限校验**
  - `@RequirePermission`: 需要特定权限
  - `@RequireRole`: 需要特定角色
  - `@RequireTenantAdmin`: 需要租户管理员权限

- **自动拦截**
  - 使用Spring AOP实现权限拦截
  - 权限不足时抛出 `AccessDeniedException`
  - 记录权限校验失败日志

#### 3.6.2 数据级权限过滤

**功能描述**: 在数据查询层面进行权限过滤。

**核心机制**:
- **MyBatis Plus拦截器**
  - 自动在SQL中添加租户ID条件
  - 自动在SQL中添加资源权限过滤条件
  - 确保 `SELECT *` 不会返回无权访问的数据

- **关联查询权限处理**
  - JOIN查询时自动处理多表的权限过滤
  - 子查询自动添加权限条件

### 3.7 审计日志

#### 3.7.1 权限操作审计

**功能描述**: 记录所有权限相关的操作,用于审计和问题追溯。

**记录内容**:
- 租户创建/修改/删除
- 用户加入/退出租户
- 角色创建/修改/删除
- 权限分配/移除
- 资源访问权限变更

#### 3.7.2 资源访问审计

**功能描述**: 记录用户对重要资源的访问操作。

**记录内容**:
- 用户ID、租户ID
- 访问的资源类型、资源ID
- 操作类型(查看、编辑、删除等)
- 操作时间
- 操作结果(成功/失败)

## 4. 非功能性描述

### 4.1 运行环境

| 组件 | 要求 |
|-----|------|
| **操作系统** | Linux (CentOS 7+/Ubuntu 18.04+)、Windows Server 2016+ |
| **Java版本** | Java 25 |
| **数据库** | PostgreSQL 14+ |
| **缓存** | Redis 6+ |
| **应用服务器** | Spring Boot 3.5.9 内置Tomcat |

### 4.2 性能要求

| 指标 | 要求 |
|-----|------|
| **权限校验响应时间** | < 10ms (内存缓存) |
| **租户切换响应时间** | < 500ms |
| **权限查询响应时间** | < 100ms |
| **并发用户数** | 支持 10000+ 并发用户 |
| **租户数量** | 支持 10000+ 租户 |

### 4.3 安全要求

- **权限最小化原则**: 用户只拥有完成任务所需的最小权限
- **权限分离原则**: 关键操作需要多个角色配合
- **审计追踪**: 所有权限操作必须记录日志,不可篡改
- **数据加密**: 敏感数据存储加密,传输使用HTTPS
- **防止越权**: 严格的前后端权限校验,防止水平越权和垂直越权

### 4.4 可用性要求

- **系统可用性**: 99.9% (月度)
- **权限系统故障不影响其他功能**: 权限服务故障时降级为只读模式
- **租户隔离**: 单个租户的故障不影响其他租户

### 4.5 可扩展性要求

- **动态权限**: 支持运行时添加新的资源类型和权限类型
- **多级权限**: 支持资源分组和多级权限继承
- **权限模板**: 支持创建权限模板,简化权限分配

## 5. 待确认问题

在需求分析过程中,以下问题需要与业务方确认:

### 5.1 功能相关

1. ~~**租户管理员权限**~~ ✅ 已确认
   - ~~租户管理员是否可以修改自己的权限?还是需要平台超级管理员操作?~~
   - ~~租户管理员是否可以创建其他租户管理员?~~
   - **已明确**: 租户管理员自动拥有当前租户的所有权限,不需要额外分配;租户管理员可以创建/移除其他租户管理员

2. ~~**跨租户资源共享**~~ ❌ 暂不考虑
   - ~~是否需要支持跨租户的资源分享功能?~~
   - ~~如果需要,分享的权限如何控制?~~
   - **决策**: 当前版本不实现跨租户资源共享,不同租户之间资源严格隔离

3. ~~**资源审批流程**~~ ❌ 暂不考虑
   - ~~用户创建敏感资源(如AI模型)是否需要审批?~~
   - ~~审批流程是否可以自定义?~~
   - **决策**: 当前版本不实现资源审批流程,用户根据权限直接创建资源

4. ~~**权限继承**~~ ✅ 已确认
   - ~~知识库的权限继承是否支持多级?~~
   - ~~如果父级权限和子级权限冲突,以哪个为准?~~
   - **已明确**: 支持多级权限继承;当父级权限和子级权限冲突时,**以子级权限为准**(子级权限优先级高于父级)

5. ~~**权限时效**~~ ✅ 已确认
   - ~~是否需要支持临时授权(如某个用户在特定时间段内拥有某个权限)?~~
   - ~~权限到期后是否自动回收?~~
   - **已明确**: 支持临时授权功能,权限到期后自动回收;支持相对时间和绝对时间设置;支持权限续期和到期提醒

### 5.2 技术相关

1. **权限缓存策略**
   - 权限信息是否需要缓存?缓存的失效策略是什么?
   - 权限变更后如何快速刷新所有节点的缓存?

2. **数据迁移**
   - 如果未来需要支持单租户到多租户的迁移,需要考虑哪些兼容性问题?

3. **权限计算性能**
   - 当用户拥有大量资源和权限时,如何保证权限计算的性能?
   - 是否需要预计算用户的有效权限?

### 5.3 业务相关

1. ~~**租户配额**~~ ❌ 暂不考虑
   - ~~租户配额超限后如何处理?是拒绝操作还是按量计费?~~
   - ~~是否需要支持配额的动态调整?~~
   - **决策**: 当前版本不实现租户配额管理,租户资源数量不受限制

2. **租户生命周期**
   - 租户到期后数据如何处理?是删除还是归档?
   - 是否需要支持租户的导出和导入?

3. ~~**默认权限**~~ ✅ 已确认
   - ~~新用户加入租户时的默认权限是什么?~~
   - ~~是否可以为不同角色的用户设置不同的默认权限?~~
   - **已明确**:
     - 新用户默认角色为**普通用户(USER)**
     - **每个角色都可以配置默认权限模板**
     - 用户获得角色时自动应用该角色的默认权限
     - 租户管理员可以自定义不同角色的默认权限
     - 用户的最终权限 = 角色默认权限 + 管理员额外分配的权限

## 6. 后续工作

本需求文档完成后,需要进行以下工作:

1. **需求评审**: 与产品、开发、测试团队进行需求评审
2. **架构设计**: 设计多租户权限管理的技术架构
3. **数据模型设计**: 设计租户、角色、权限、资源等数据模型
4. **API设计**: 设计租户管理、权限分配、权限校验等API接口
5. **开发排期**: 制定详细的开发计划和里程碑
6. **测试方案**: 制定测试方案和测试用例

---

**文档变更历史**:

| 版本号 | 日期 | 变更内容 | 变更人 |
|-------|------|---------|-------|
| 1.0.0 | 2026-01-27 | 初始版本,完成多租户权限管理需求分析 | Claude |
| 1.0.1 | 2026-01-28 | 明确租户管理员权限机制和角色分配规则 | Claude |
| 1.0.2 | 2026-01-28 | 明确知识库多级权限继承规则、添加权限时效管理功能 | Claude |
| 1.0.3 | 2026-01-28 | 移除租户配额管理功能,简化当前版本需求 | Claude |
| 1.0.4 | 2026-01-28 | 明确新用户默认角色和角色默认权限模板机制 | Claude |
